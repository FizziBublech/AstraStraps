<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AstraStraps | Issue Dashboard</title>
    <link rel="stylesheet" href="dashboard.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script
        src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
</head>

<body>
    <div class="container">
        <header>
            <h1>Issue Dashboard</h1>
            <p class="subtitle">Actionable insights from Convocore transcripts.</p>
        </header>

        <div id="stats-panel" class="stats-panel">
            <!-- Stats will be injected here -->
        </div>

        <div class="chart-container" style="position: relative; height: 400px; width: 100%; margin-bottom: 3rem;">
            <canvas id="errorTimeline"></canvas>
        </div>

        <div id="summary-container"></div>

        <div id="dashboard" class="dashboard-grid">
            <!-- Cards will be injected here -->
            <div class="loading">Loading issues...</div>
        </div>
    </div>

    <script>
        let timelineChart = null;

        async function loadIssues() {
            try {
                // Check if Chart is available
                if (typeof Chart === 'undefined') {
                    console.warn('Chart.js not loaded. Timeline will be disabled.');
                    const chartContainer = document.getElementById('errorTimeline').parentElement;
                    if (chartContainer) {
                        chartContainer.innerHTML =
                            '<div class="error-msg" style="color: #f59e0b; text-align: center; padding: 2rem; border: 1px dashed #f59e0b; border-radius: 8px;">Chart.js failed to load. Check internet connection.</div>';
                    }
                }

                const [issuesResponse, statsResponse] = await Promise.all([
                    fetch('/api/issues'),
                    fetch('/api/stats')
                ]);

                if (!issuesResponse.ok) throw new Error(`Issues API Error: ${issuesResponse.status}`);
                let issues = await issuesResponse.json();

                if (!Array.isArray(issues)) {
                    throw new Error('API returned invalid data format (expected array)');
                }

                let dailyStats = {};
                if (statsResponse.ok) {
                    try {
                        dailyStats = await statsResponse.json();
                    } catch (e) {
                        console.error('Failed to parse stats', e);
                    }
                } else {
                    console.warn(`Stats API Error: ${statsResponse.status}`);
                }

                // Sort newest on top
                issues.sort((a, b) => new Date(b.date) - new Date(a.date));
                renderDashboard(issues, dailyStats);
            } catch (error) {
                console.error('Error loading data:', error);
                document.getElementById('dashboard').innerHTML =
                    `<p style="grid-column: 1/-1; text-align: center; color: #ef4444;">
                        Failed to load data.<br>
                        <small>${error.message}</small>
                    </p>`;
            }
        }

        function calculateStats(issues) {
            const stats = {
                totalErrors: 0,
                totalUnhappy: 0,
                totalMitigated: 0,
                totalRemediated: issues.length,
                categories: {},
                tags: {},
                byDay: {}
            };

            issues.forEach(issue => {
                if (issue.is_technical_error) stats.totalErrors++;
                if (issue.is_unhappy_customer) stats.totalUnhappy++;
                if (issue.status === 'Resolved' || issue.mitigation_notes) stats.totalMitigated++;

                const day = issue.date.split(' ')[0];
                if (!stats.byDay[day]) {
                    stats.byDay[day] = { count: 0, errors: 0, unhappy: 0 };
                }
                stats.byDay[day].count++;
                if (issue.is_technical_error) stats.byDay[day].errors++;
                if (issue.is_unhappy_customer) stats.byDay[day].unhappy++;

                const cat = issue.error_category || 'UNCATEGORIZED';
                if (cat !== 'NONE') {
                    stats.categories[cat] = (stats.categories[cat] || 0) + 1;
                }

                const tag = issue.error_tag || 'NONE';
                if (tag !== 'NONE') {
                    stats.tags[tag] = (stats.tags[tag] || 0) + 1;
                }
            });

            return stats;
        }

        function renderStats(stats) {
            const panel = document.getElementById('stats-panel');

            // Sort tags by count
            const topTags = Object.entries(stats.tags)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 4);

            let tagHtml = topTags.map(([tag, count]) => `
                <div class="stat-card">
                    <div class="stat-value" style="color: var(--accent-purple)">${count}</div>
                    <div class="stat-label">${tag}</div>
                </div>
            `).join('');

            panel.innerHTML = `
                <div class="stat-card">
                    <div class="stat-value" style="color: var(--accent-red)">${stats.totalErrors}</div>
                    <div class="stat-label">Tech Errors</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" style="color: #f59e0b">${stats.totalUnhappy}</div>
                    <div class="stat-label">Unhappy Customers</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" style="color: var(--accent-green)">${stats.totalMitigated}</div>
                    <div class="stat-label">Fully Mitigated</div>
                </div>
                ${tagHtml}
            `;
        }

        function renderTimeline(issues) {
            if (typeof Chart === 'undefined') return;

            const canvas = document.getElementById('errorTimeline');
            if (!canvas) return;
            const ctx = canvas.getContext('2d');

            // Sort issues by date
            const sortedIssues = [...issues].sort((a, b) => new Date(a.date) - new Date(b.date));

            // Group by Category and Date (Day)
            const datasets = {};
            const categories = ['SYSTEM', 'LOGIC', 'DATA', 'UI', 'NLU', 'OTHER'];
            const colors = {
                'SYSTEM': '#ef4444',
                'LOGIC': '#f59e0b',
                'DATA': '#3b82f6',
                'UI': '#10b981',
                'NLU': '#8b5cf6',
                'OTHER': '#6b7280'
            };

            categories.forEach(cat => {
                datasets[cat] = {
                    label: cat,
                    data: [],
                    borderColor: colors[cat] || '#888',
                    backgroundColor: colors[cat] || '#888',
                    showLine: false, // Scatter style
                    pointRadius: 6,
                    pointHoverRadius: 8
                };
            });

            sortedIssues.forEach(issue => {
                const cat = issue.error_category || 'OTHER';
                if (datasets[cat]) {
                    const catIndex = categories.indexOf(cat);
                    datasets[cat].data.push({
                        x: issue.date,
                        y: catIndex + 1, // 1-based index
                        issue: issue
                    });
                }
            });

            if (timelineChart) {
                timelineChart.destroy();
            }

            timelineChart = new Chart(ctx, {
                type: 'scatter',
                data: {
                    datasets: Object.values(datasets).filter(d => d.data.length > 0)
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: {
                            type: 'time',
                            time: {
                                unit: 'day'
                            },
                            grid: {
                                color: 'rgba(255, 255, 255, 0.1)'
                            },
                            ticks: {
                                color: '#a0a0a0'
                            }
                        },
                        y: {
                            min: 0,
                            max: 7,
                            ticks: {
                                callback: function (value, index, values) {
                                    return categories[value - 1] || '';
                                },
                                color: '#a0a0a0'
                            },
                            grid: {
                                color: 'rgba(255, 255, 255, 0.1)'
                            }
                        }
                    },
                    plugins: {
                        tooltip: {
                            callbacks: {
                                label: function (context) {
                                    const issue = context.raw.issue;
                                    return `${issue.error_tag || 'Error'}: ${issue.id}`;
                                },
                                afterLabel: function (context) {
                                    const issue = context.raw.issue;
                                    return issue.mitigation_notes ? 'Has Mitigation' : '';
                                }
                            }
                        },
                        legend: {
                            labels: {
                                color: '#fff'
                            }
                        }
                    }
                }
            });
        }

        function renderRemediationTable(stats, dailyStats) {
            const container = document.getElementById('summary-container');
            const allDays = new Set([...Object.keys(stats.byDay), ...Object.keys(dailyStats)]);
            const dayList = Array.from(allDays).sort((a, b) => new Date(b) - new Date(a));

            let tableHtml = `
                <div class="remediation-summary" style="margin-bottom: 2rem; background: var(--card-bg); border-radius: 1rem; padding: 1.5rem; border: 1px solid var(--glass-border);">
                    <h3 style="margin-top:0; margin-bottom: 1rem; color: var(--text-primary);">Daily Remediation Summary</h3>
                    <table style="width: 100%; border-collapse: collapse; font-size: 0.9rem;">
                        <thead>
                            <tr style="text-align: left; border-bottom: 1px solid var(--glass-border); color: var(--text-secondary);">
                                <th style="padding: 0.5rem;">Date</th>
                                <th style="padding: 0.5rem;">Total Convos</th>
                                <th style="padding: 0.5rem;">Errors (%)</th>
                                <th style="padding: 0.5rem;">Unhappy (%)</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${dayList.map(day => {
                const issueStats = stats.byDay[day] || { errors: 0, unhappy: 0 };
                const total = dailyStats[day] || issueStats.count || 0;
                const validTotal = total > 0 ? total : 1;
                const errorPct = ((issueStats.errors / validTotal) * 100).toFixed(1);
                const unhappyPct = ((issueStats.unhappy / validTotal) * 100).toFixed(1);
                return `
                                    <tr style="border-bottom: 1px solid rgba(255,255,255,0.05);">
                                        <td style="padding: 0.5rem;">${day}</td>
                                        <td style="padding: 0.5rem;">${total}</td>
                                        <td style="padding: 0.5rem; color: ${issueStats.errors > 0 ? 'var(--accent-red)' : 'inherit'}">${issueStats.errors} (${errorPct}%)</td>
                                        <td style="padding: 0.5rem; color: ${issueStats.unhappy > 0 ? '#f59e0b' : 'inherit'}">${issueStats.unhappy} (${unhappyPct}%)</td>
                                    </tr>
                                `;
            }).join('')}
                        </tbody>
                    </table>
                </div>
            `;

            container.innerHTML = tableHtml;
        }

        function renderDashboard(issues, dailyStats) {
            const dashboard = document.getElementById('dashboard');
            const localStats = calculateStats(issues);
            renderStats(localStats);
            renderRemediationTable(localStats, dailyStats);
            renderTimeline(issues);

            if (issues.length === 0) {
                dashboard.innerHTML = '<p style="grid-column: 1/-1; text-align: center; color: var(--text-secondary);">No issues logged yet.</p>';
                return;
            }

            dashboard.innerHTML = issues.map(issue => {
                const badges = [];
                if (issue.is_technical_error) badges.push('<span class="badge badge-error">Technical Error</span>');
                if (issue.is_unhappy_customer) badges.push('<span class="badge badge-unhappy">Unhappy Customer</span>');
                if (issue.error_category && issue.error_category !== 'NONE') {
                    badges.push(`<span class="badge badge-category">${issue.error_category.replace(/_/g, ' ')}</span>`);
                }
                if (issue.error_tag && issue.error_tag !== 'NONE') {
                    badges.push(`<span class="badge" style="background: rgba(255, 255, 255, 0.1); border: 1px solid rgba(255,255,255,0.2);">${issue.error_tag}</span>`);
                }

                let mitigationHtml = '';
                if (issue.mitigation_notes) {
                    mitigationHtml = `
                        <div class="mitigation-box">
                            <span class="mitigation-title">Mitigation Actions</span>
                            <div class="mitigation-content">${issue.mitigation_notes}</div>
                        </div>
                    `;
                }

                let statusBadge = `
                    <div class="status-indicator">
                        <div class="dot dot-${issue.status.toLowerCase()}"></div>
                        <span>${issue.status}</span>
                    </div>
                `;

                return `
                    <div class="card">
                        <div class="card-header">
                            <span class="convo-id">${issue.id}</span>
                        </div>
                        <div class="timestamp">${issue.date}</div>
                        <div style="display: flex; gap: 0.5rem; flex-wrap: wrap; margin-bottom: 1rem;">${badges.join('')}</div>
                        
                        <div class="analysis-text">${formatAnalysis(issue.analysis)}</div>
                        
                        ${mitigationHtml}
                        
                        <div class="card-footer">
                            ${statusBadge}
                            ${issue.deleted_from_frontend ? '<span class="delete-tag">DELETED FROM API</span>' : ''}
                        </div>
                    </div>
                `;
            }).join('');
        }

        function formatAnalysis(text) {
            if (!text) return '';
            return text
                .replace(/TECHNICAL_ERROR: /gi, '<strong>Error: </strong>')
                .replace(/UNHAPPY_CUSTOMER: /gi, '<br><strong>Sentiment: </strong>')
                .replace(/ERROR_CATEGORY: /gi, '<br><strong>Category: </strong>')
                .replace(/SUMMARY: /gi, '<br><br><strong>Summary: </strong>')
                .replace(/\[YES\]/g, 'YES')
                .replace(/\[NO\]/g, 'NO');
        }

        loadIssues();
        setInterval(loadIssues, 30000);
    </script>
</body>

</html>